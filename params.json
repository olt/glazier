{"name":"Glazier","body":"# Why Glazier?\r\n\r\nI first got involved with CouchDB around 0.7, and liked what I saw. Only\r\nhaving a low-spec Windows PC to develop on, and no CouchDB Cloud provider\r\nbeing available, I tried to build CouchDB myself. It was hard going, and\r\nmost of the frustration was trying to get the core Erlang environment set\r\nup and working without needing to buy Microsoft's expensive but excellent\r\nVisual Studio tools myself. Once Erlang was working I found many of the\r\npre-requisite modules such as cURL, Zlib, OpenSSL, Mozilla's SpiderMonkey\r\nJavaScript engine, and IBM's ICU were not available at a consistent\r\ncompiler and VC runtime release.\r\n\r\nGlazier is a set of related scripts and toolchains to ease that pain.\r\nIt's not fully automated but most of the effort is only required once.\r\nI hope it simplifies using Erlang and CouchDB for you by giving you a\r\nconsistent repeatable build environment.\r\n\r\n## Download Glazier scripts, tools, and source\r\n\r\n* download [glazier latest](https://nodeload.github.com/dch/glazier/zipball/master)\r\n* unpack it into `c:\\relax` - you should have `c:\\relax\\bin` for example\r\n* download source & tools using aria, and then check MD5 hashes:\r\n\r\n        pushd c:\\relax\r\n        path=c:\\relax\\bin;%path%\r\n        aria2c.exe --force-sequential=false --max-connection-per-server=5 \\\r\n            --check-certificate=false --auto-file-renaming=false \\\r\n            --input-file=downloads.md --max-concurrent-downloads=5 \\\r\n            --dir=bits --save-session=bits/a2session.txt\r\n        cd bits && md5sum.exe --check ..\\downloads.md5\r\n\r\n## Install Compilers\r\n\r\nDue to size, these are not downloaded in the bundle apart from\r\nmozilla & cygwin setup.\r\n\r\n* Install one of either Windows SDK 7.0, or 7.1, in either 32 or 64bit\r\nas appropriate for your platform using:\r\n    * SDK 7.0 [win70sdk_websetup] or a downloaded [win70sdk_iso]\r\n    * SDK 7.1 [win71sdk_websetup] or a downloaded [win71sdk_iso]\r\n* Run Windows Update for latest patches\r\n* Reboot\r\n* Download Mozilla toolkit from [mozbuild] and install per defaults\r\n* Install [cygwin] components, at least:\r\n    * devel: ALL (or just the GCC and GCC C++ compilers and GNU auto)\r\n    * editors: vim or emacs\r\n    * utils: file\r\n\r\n[cygwin]: http://www.cygwin.com/setup.exe\r\n[win71sdk_websetup]: http://www.microsoft.com/download/en/confirmation.aspx?id=8279\r\n[win71sdk_iso]:\thttp://go.microsoft.com/fwlink/?LinkID=191420\r\n[win70sdk_websetup]: http://www.microsoft.com/download/en/details.aspx?id=3138\r\n[win70sdk_iso]:\thttp://go.microsoft.com/fwlink/?LinkID=150216\r\n[mozbuild]: http://ftp.mozilla.org/pub/mozilla.org/mozilla/libraries/win32/MozillaBuildSetup-1.6.exe\r\n\r\n## Initial Setup of Environment\r\n\r\nNow that the compilers are installed, we need to set a few things up first:\r\n\r\n* start an SDK shell via `setenv.cmd /Release /x86`\r\n* run `c:\\relax\\bin\\setup.cmd` once to set up links and environment variables\r\n\r\nYou should end up with something resembling this structure:\r\n\r\n        Directory of C:\\relax\r\n        06/09/2011  10:41 p.m.    <DIR>          .\r\n        06/09/2011  10:41 p.m.    <DIR>          ..\r\n        06/09/2011  10:41 p.m.    <SYMLINKD>     bin [z:\\r\\glazier\\bin]\r\n        06/09/2011  10:41 p.m.    <SYMLINKD>     bits [z:\\r\\glazier\\bits]\r\n        03/09/2011  11:00 a.m.    <DIR>          release\r\n        06/09/2011  10:40 p.m.    <SYMLINKD>     SDK [C:\\Program Files\\Microsoft SDKs\\Windows\\v7.1]\r\n        06/09/2011  12:19 a.m.    <SYMLINKD>     tmp [C:\\Users\\couch\\AppData\\Local\\Temp]\r\n        06/09/2011  10:40 p.m.    <SYMLINKD>     VC [c:\\Program Files (x86)\\Microsoft Visual Studio 10.0\\VC\\..]\r\n\r\n\r\n## Install downloaded tools\r\n\r\nThe Microsoft Visual C++ runtime redistributales are bundled with Erlang\r\nand CouchDB by default.\r\n\r\n* for Windows SDK 7.1, copy [vcredist_sdk71] to `%relax%/`\r\n* for Windows SDK 7.0, copy [vcredist_sdk70] to `%relax%/`\r\n\r\nThe express solution is just to use 7zip to unpack [glazier tools](https://github.com/downloads/dch/glazier/toolbox.7z)\r\n inside `%relax%`. Or do it manually for the same result:\r\n\r\n* Add 7zip from `c:\\mozilla-build\\7zip` to your path\r\n* Innosoft's [isetup] to `%relax%/inno5`\r\n* Nullsoft [NSIS] Installer to `%relax%/nsis`\r\n* Add 7zip, Inno5, and nsis to the user environment PATH\r\n* using 7zip, extract and rename [nasm] to `%relax%/nasm`\r\n* using 7zip, extract and rename [cmake] to `%relax%/cmake`\r\n* `mkdir strawberry && cd strawberry` then using 7zip, extract Strawberry [Perl]\r\n\r\n[perl]: http://strawberryperl.com/download/5.12.2.0/strawberry-perl-5.12.2.0-portable.zip\r\n[nasm]: http://www.nasm.us/pub/nasm/releasebuilds/2.09.07/win32/nasm-2.09.07-win32.zip\r\n[cmake]: http://www.cmake.org/files/v2.8/cmake-2.8.6-win32-x86.zip\r\n[vcredist_sdk71]: http://download.microsoft.com/download/1/6/5/165255E7-1014-4D0A-B094-B6A430A6BFFC/vcredist_x86.exe\r\n[nsis]: http://download.sourceforge.net/project/nsis/NSIS%202/2.46/nsis-2.46-setup.exe\r\n[isetup]: http://www.jrsoftware.org/download.php/is-unicode.exe\r\n\r\n## wxWidgets\r\n\r\n* [wxWidgets] source should already be downloaded into `%relax%/bits/`\r\n* start an SDK shell via `setenv.cmd /Release /x86`\r\n* run `c:\\relax\\bin\\build_wx.cmd` to extract and build wxWidgets\r\n* NB Erlang build requires softlinked wxWidgets in `/opt/local/pgm/wxWidgets-2.8.12` so\r\n  we set that up too\r\n* check for errors\r\n\r\n[wxwidgets]: http://sourceforge.net/projects/wxwindows/files/2.8.12/wxMSW-2.8.12.zip\r\n\r\n## OpenSSL\r\n\r\nErlang requires finding OpenSSL in `c:\\OpenSSL` so that's where we build to,\r\nusing mount point to keep things clean=ish under `%relax%`.\r\n\r\n* [OpenSSL] source has already been downloaded\r\n* start an SDK shell via `setenv.cmd /Release /x86`\r\n* run `c:\\relax\\bin\\build_openssl.cmd` to extract and build OpenSSL\r\n* it requires nasm, 7zip, strawberry perl all in place\r\n* check for errors\r\n* ensure Erlang can locate SSL with `mklink /d c:\\OpenSSL %relax%\\OpenSSL`\r\n* the resulting DLLs in `c:\\relax\\openssl\\bin` need to be distributed with\r\nErlang/OTP and therefore CouchDB as well.\r\n\r\n[openssl]: http://www.openssl.org/source/openssl-0.9.8r.tar.gz\r\n\r\n## Environment\r\n\r\nOur goal is to get the path set up in this order:\r\n\r\n1. erlang and couchdb build helper scripts\r\n2. Microsoft VC compiler, linker, etc from Windows SDK\r\n3. cygwin path for other build tools like make, autoconf, libtool\r\n4. the remaining windows system path\r\n\r\nThe express start is to:\r\n\r\n* start an SDK shell via `setenv.cmd /Release /x86`\r\n* launch a cygwin erl-ified shell via `c:\\relax\\bin\\shell.cmd`\r\n* go to next section to compile Erlang/OTP\r\n\r\nAlternatively, you can launch your own cmd prompt, and ensure that your system\r\npath is correct first in the win32 side before starting cygwin. Once in cygwin\r\ngo to the root of where you installed erlang, and run the Erlang/OTP script:\r\n\r\n        eval `./otp_build env_win32`\r\n        echo $PATH | /bin/sed 's/:/\\n/g'\r\n        which cl link mc lc mt\r\n\r\nConfirm that output of `which` returns only MS versions from VC++ or the SDK.\r\nThis is critical and if not correct will cause confusing errors much later on.\r\nOverall, the desired order for your $PATH is:\r\n\r\n* Erlang build helper scripts\r\n* Windows SDK tools, .Net framework\r\n* Visual C++ if installed\r\n* Ancillary Erlang and CouchDB packaging tools\r\n* Usual cygwin unix tools such as make, gcc\r\n* Ancillary glazier/relax tools for building dependent libraries\r\n* Usual Windows folders `%windir%;%windir%\\system32` etc\r\n* Various settings form the `otp_build` script\r\n\r\nMore details are at [erlang INSTALL-Win32.md on github](http://github.com/erlang/otp/blob/dev/INSTALL-WIN32.md)\r\n\r\n## Erlang\r\n\r\n\r\n* start an SDK shell via `setenv.cmd /Release /x86`\r\n* launch a cygwin erl-ified shell via `c:\\relax\\bin\\shell.cmd`\r\n* choose your erlang version - R14B04 is strongly advised\r\n* unpack erlang source by `cd $RELAX && tar xzf bits/otp_src_R14B04.tar.gz`\r\n* customise Erlang by excluding unneeded Java interface and old GS GUI:\r\n\r\n        cd $ERL_TOP\r\n        tar xvzf /relax/bits/tcltk85_win32_bin.tar.gz\r\n        echo \"skipping gs\" > lib/gs/SKIP\r\n        echo \"skipping jinterface\" > lib/jinterface/SKIP\r\n\r\n\r\n* after validating the path, I usually run these two scripts which\r\ncan take several hours on slower machines:\r\n\r\n        erl_config.sh\r\n        erl_build.sh\r\n\r\n* the output is logged into `$ERL_TOP/build_*.txt` if required\r\n* at this point I usually duplicate the OTP source tree for later\r\n\r\n        robocopy $ERL_TOP /relax/release/$OTP_REL -mir\r\n\r\n\r\n## ICU 4.6.1\r\n\r\n* Download ICU 4.6.1 windows source from [icu461zip]\r\n* either re-use the \"shell.cmd\" from before, or open a Windows SDK prompt\r\nvia `setenv /release /x86` again\r\n\r\n        %relax%\\bin\\build_icu.cmd\r\n\r\n* confirm that the resulting ICU DLLs have the appropriate manifests\r\n\r\n[icu461zip]: http://download.icu-project.org/files/icu4c/4.6.1/icu4c-4_6_1-src.zip\r\n[icu461tgz]: http://download.icu-project.org/files/icu4c/4.6.1/icu4c-4_6_1-src.tgz\r\n\r\n* NB for MSVC9 is supported only via cygwin; use [icu461tgz] instead and\r\n\r\n        cd $RELAX\r\n        DEST=`pwd`/icu\r\n        tar xzf bits/icu4c-4_6_1-src.tgz\r\n        cd $DEST/source && ./runConfigureICU Cygwin/MSVC --prefix=$DEST\r\n        make && make install\r\n        cp $DEST/lib/*.dll $DEST/bin/\r\n\r\n* compiling under cygwin is likely also to work for MSVC10 if a unified\r\n  build process is required.\r\n\r\n## libcurl\r\n\r\nlibcurl is only required for versions of CouchDB below 1.1.1 where it is embedded\r\nin couchjs.exe. Trunk and future releases will have this as an optional include.\r\n\r\n\r\n* download [libcurl] source from (http://curl.haxx.se/)\r\n* NB when using SDK7.0 I needed to `copy %windir%\\system32\\notepad.exe c:\\relax\\bin\\bscmake.exe`\r\n* either re-use the \"shell.cmd\" from before, or open a Windows SDK prompt\r\nvia `setenv /release /x86` again\r\n\r\n        %relax%\\bin\\build_curl.cmd\r\n\r\n[libcurl]: http://curl.haxx.se/download/curl-7.23.1.zip\r\n\r\n## Javascript\r\n\r\nThe Javascript engine used by CouchDB is Mozilla Spidermonkey v1.8.5 [js185].\r\n\r\n* to build and install SpiderMonkey we use the mozilla tools chain.\r\n* run `c:\\mozilla-build\\start-msvc10.bat` even if you are on a 64-bit platform.\r\n* do a sanity check to confirm the MS build compilers are present via\r\n `which cl link mc lc mt`\r\n* you may need to fudge the path if `cl.exe` can't be found using `PATH=$PATH:/c/relax/VC/VC/bin/:/c/relax/SDK/bin:/c/relax/VC/Common7/IDE:/c/relax/VC/VC/bin/amd64/:/c/relax/VC/VC/bin/x86_ia64/`\r\n\r\n        cd /c/relax\r\n        tar xzf bits/js185-1.0.0.tar.gz\r\n        cd ./js-1.8.5/js/src\r\n        autoconf-2.13\r\n        ./configure --enable-static --enable-shared-js\r\n        make\r\n\r\n[js185]: http://ftp.mozilla.org/pub/mozilla.org/js/js185-1.0.0.tar.gz\r\n\r\n## Building CouchDB\r\n\r\nFinally we are going to build Apache CouchDB... whew! Recapping, we should have:\r\n\r\n* erlang in `/relax/otp_src_R14B04/release/win32` with a copy stashed nearby\r\n* openssl in `/relax/openssl/{bin,lib}/{lib,ssl}eay32.{bin,lib}`\r\n* libcurl in `/relax/curl/lib/libcurl.lib`\r\n* js library in `/relax/js-1.8.5/js/src/dist/{bin,lib}/mozjs185-1.0.*`\r\n* icu in `/relax/icu/bin/icu*.dll`\r\n\r\nFor CouchDB 1.1.1 or newer, two small filthy hacks are required, which\r\nis needed until `configure.ac` avoids detection of cygwin's curl and avoids\r\nassuming that help2man will be useful on Windows.\r\n\r\n* start an SDK shell via `setenv.cmd /Release /x86`\r\n* launch a cygwin erl-ified shell via `c:\\relax\\bin\\shell.cmd`\r\n* apply the work-arounds:\r\n\r\n        mv /usr/bin/curl-config /usr/bin/curl-config.dist\r\n        mv /usr/bin/help2man /usr/bin/help2man.dist\r\n\r\n\r\nThere are two relevant scripts for building CouchDB:\r\n\r\n* `couchdb_config.sh` for CouchDB 1.1.1 or newer, supporting js185 only\r\n* `couchdb_build.sh` which compiles, and packages, CouchDB\r\n\r\nLet's pull the CouchDB source from git repo:\r\n\r\n        git clone http://git-wip-us.apache.org/repos/asf/couchdb.git \\\r\n          /relax/couchdb\r\n        pushd /relax/couchdb && git checkout -b 1.2.0\r\n        git clean -fdx && git reset --hard\r\n        ./bootstrap\r\n        /relax/bin/couchdb_config.sh && /relax/bin/couchdb_build.sh\r\n\r\nA few minutes later, the release binaries should be made available.\r\n\r\n","tagline":"Automate building of CouchDB from source on Windows, including all dependent libraries and binaries for a clean build against a single VC++ runtime.","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}