<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Glazier : Automate building of CouchDB from source on Windows, including all dependent libraries and binaries for a clean build against a single VC++ runtime." />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Glazier</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/dch/glazier">Fork Me on GitHub</a>

          <h1 id="project_title">Glazier</h1>
          <h2 id="project_tagline">Automate building of CouchDB from source on Windows, including all dependent libraries and binaries for a clean build against a single VC++ runtime.</h2>

          <section id="downloads">
            <a class="zip_download_link" href="https://github.com/dch/glazier/zipball/master">Download this project as a .zip file</a>
            <a class="tar_download_link" href="https://github.com/dch/glazier/tarball/master">Download this project as a tar.gz file</a>
          </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h1>Why Glazier?</h1>

<p>I first got involved with CouchDB around 0.7, and liked what I saw. Only
having a low-spec Windows PC to develop on, and no CouchDB Cloud provider
being available, I tried to build CouchDB myself. It was hard going, and
most of the frustration was trying to get the core Erlang environment set
up and working without needing to buy Microsoft's expensive but excellent
Visual Studio tools myself. Once Erlang was working I found many of the
pre-requisite modules such as cURL, Zlib, OpenSSL, Mozilla's SpiderMonkey
JavaScript engine, and IBM's ICU were not available at a consistent
compiler and VC runtime release.</p>

<p>Glazier is a set of related scripts and toolchains to ease that pain.
It's not fully automated but most of the effort is only required once.
I hope it simplifies using Erlang and CouchDB for you by giving you a
consistent repeatable build environment.</p>

<h2>Download Glazier scripts, tools, and source</h2>

<ul>
<li>download <a href="https://nodeload.github.com/dch/glazier/zipball/master">glazier latest</a>
</li>
<li>unpack it into <code>c:\relax</code> - you should have <code>c:\relax\bin</code> for example</li>
<li>
<p>download source &amp; tools using aria, and then check MD5 hashes:</p>

<pre><code>pushd c:\relax
path=c:\relax\bin;%path%
aria2c.exe --force-sequential=false --max-connection-per-server=5 \
    --check-certificate=false --auto-file-renaming=false \
    --input-file=downloads.md --max-concurrent-downloads=5 \
    --dir=bits --save-session=bits/a2session.txt
cd bits &amp;&amp; md5sum.exe --check ..\downloads.md5
</code></pre>
</li>
</ul><h2>Install Compilers</h2>

<p>Due to size, these are not downloaded in the bundle apart from
mozilla &amp; cygwin setup.</p>

<ul>
<li>Install one of either Windows SDK 7.0, or 7.1, in either 32 or 64bit
as appropriate for your platform using:

<ul>
<li>SDK 7.0 <a href="http://www.microsoft.com/download/en/details.aspx?id=3138">win70sdk_websetup</a> or a downloaded <a>win70sdk_iso</a>
</li>
<li>SDK 7.1 <a href="http://www.microsoft.com/download/en/confirmation.aspx?id=8279">win71sdk_websetup</a> or a downloaded <a>win71sdk_iso</a>
</li>
</ul>
</li>
<li>Run Windows Update for latest patches</li>
<li>Reboot</li>
<li>Download Mozilla toolkit from <a href="http://ftp.mozilla.org/pub/mozilla.org/mozilla/libraries/win32/MozillaBuildSetup-1.6.exe">mozbuild</a> and install per defaults</li>
<li>Install <a href="http://www.cygwin.com/setup.exe">cygwin</a> components, at least:

<ul>
<li>devel: ALL (or just the GCC and GCC C++ compilers and GNU auto)</li>
<li>editors: vim or emacs</li>
<li>utils: file</li>
</ul>
</li>
</ul><h2>Initial Setup of Environment</h2>

<p>Now that the compilers are installed, we need to set a few things up first:</p>

<ul>
<li>start an SDK shell via <code>setenv.cmd /Release /x86</code>
</li>
<li>run <code>c:\relax\bin\setup.cmd</code> once to set up links and environment variables</li>
</ul><p>You should end up with something resembling this structure:</p>

<pre><code>    Directory of C:\relax
    06/09/2011  10:41 p.m.    &lt;DIR&gt;          .
    06/09/2011  10:41 p.m.    &lt;DIR&gt;          ..
    06/09/2011  10:41 p.m.    &lt;SYMLINKD&gt;     bin [z:\r\glazier\bin]
    06/09/2011  10:41 p.m.    &lt;SYMLINKD&gt;     bits [z:\r\glazier\bits]
    03/09/2011  11:00 a.m.    &lt;DIR&gt;          release
    06/09/2011  10:40 p.m.    &lt;SYMLINKD&gt;     SDK [C:\Program Files\Microsoft SDKs\Windows\v7.1]
    06/09/2011  12:19 a.m.    &lt;SYMLINKD&gt;     tmp [C:\Users\couch\AppData\Local\Temp]
    06/09/2011  10:40 p.m.    &lt;SYMLINKD&gt;     VC [c:\Program Files (x86)\Microsoft Visual Studio 10.0\VC\..]
</code></pre>

<h2>Install downloaded tools</h2>

<p>The Microsoft Visual C++ runtime redistributales are bundled with Erlang
and CouchDB by default.</p>

<ul>
<li>for Windows SDK 7.1, copy <a href="http://download.microsoft.com/download/1/6/5/165255E7-1014-4D0A-B094-B6A430A6BFFC/vcredist_x86.exe">vcredist_sdk71</a> to <code>%relax%/</code>
</li>
<li>for Windows SDK 7.0, copy [vcredist_sdk70] to <code>%relax%/</code>
</li>
</ul><p>The express solution is just to use 7zip to unpack <a href="https://github.com/downloads/dch/glazier/toolbox.7z">glazier tools</a>
 inside <code>%relax%</code>. Or do it manually for the same result:</p>

<ul>
<li>Add 7zip from <code>c:\mozilla-build\7zip</code> to your path</li>
<li>Innosoft's <a href="http://www.jrsoftware.org/download.php/is-unicode.exe">isetup</a> to <code>%relax%/inno5</code>
</li>
<li>Nullsoft <a href="http://download.sourceforge.net/project/nsis/NSIS%202/2.46/nsis-2.46-setup.exe">NSIS</a> Installer to <code>%relax%/nsis</code>
</li>
<li>Add 7zip, Inno5, and nsis to the user environment PATH</li>
<li>using 7zip, extract and rename <a href="http://www.nasm.us/pub/nasm/releasebuilds/2.09.07/win32/nasm-2.09.07-win32.zip">nasm</a> to <code>%relax%/nasm</code>
</li>
<li>using 7zip, extract and rename <a href="http://www.cmake.org/files/v2.8/cmake-2.8.6-win32-x86.zip">cmake</a> to <code>%relax%/cmake</code>
</li>
<li>
<code>mkdir strawberry &amp;&amp; cd strawberry</code> then using 7zip, extract Strawberry <a href="http://strawberryperl.com/download/5.12.2.0/strawberry-perl-5.12.2.0-portable.zip">Perl</a>
</li>
</ul><h2>wxWidgets</h2>

<ul>
<li>
<a href="http://sourceforge.net/projects/wxwindows/files/2.8.12/wxMSW-2.8.12.zip">wxWidgets</a> source should already be downloaded into <code>%relax%/bits/</code>
</li>
<li>start an SDK shell via <code>setenv.cmd /Release /x86</code>
</li>
<li>run <code>c:\relax\bin\build_wx.cmd</code> to extract and build wxWidgets</li>
<li>NB Erlang build requires softlinked wxWidgets in <code>/opt/local/pgm/wxWidgets-2.8.12</code> so
we set that up too</li>
<li>check for errors</li>
</ul><h2>OpenSSL</h2>

<p>Erlang requires finding OpenSSL in <code>c:\OpenSSL</code> so that's where we build to,
using mount point to keep things clean=ish under <code>%relax%</code>.</p>

<ul>
<li>
<a href="http://www.openssl.org/source/openssl-0.9.8r.tar.gz">OpenSSL</a> source has already been downloaded</li>
<li>start an SDK shell via <code>setenv.cmd /Release /x86</code>
</li>
<li>run <code>c:\relax\bin\build_openssl.cmd</code> to extract and build OpenSSL</li>
<li>it requires nasm, 7zip, strawberry perl all in place</li>
<li>check for errors</li>
<li>ensure Erlang can locate SSL with <code>mklink /d c:\OpenSSL %relax%\OpenSSL</code>
</li>
<li>the resulting DLLs in <code>c:\relax\openssl\bin</code> need to be distributed with
Erlang/OTP and therefore CouchDB as well.</li>
</ul><h2>Environment</h2>

<p>Our goal is to get the path set up in this order:</p>

<ol>
<li>erlang and couchdb build helper scripts</li>
<li>Microsoft VC compiler, linker, etc from Windows SDK</li>
<li>cygwin path for other build tools like make, autoconf, libtool</li>
<li>the remaining windows system path</li>
</ol><p>The express start is to:</p>

<ul>
<li>start an SDK shell via <code>setenv.cmd /Release /x86</code>
</li>
<li>launch a cygwin erl-ified shell via <code>c:\relax\bin\shell.cmd</code>
</li>
<li>go to next section to compile Erlang/OTP</li>
</ul><p>Alternatively, you can launch your own cmd prompt, and ensure that your system
path is correct first in the win32 side before starting cygwin. Once in cygwin
go to the root of where you installed erlang, and run the Erlang/OTP script:</p>

<pre><code>    eval `./otp_build env_win32`
    echo $PATH | /bin/sed 's/:/\n/g'
    which cl link mc lc mt
</code></pre>

<p>Confirm that output of <code>which</code> returns only MS versions from VC++ or the SDK.
This is critical and if not correct will cause confusing errors much later on.
Overall, the desired order for your $PATH is:</p>

<ul>
<li>Erlang build helper scripts</li>
<li>Windows SDK tools, .Net framework</li>
<li>Visual C++ if installed</li>
<li>Ancillary Erlang and CouchDB packaging tools</li>
<li>Usual cygwin unix tools such as make, gcc</li>
<li>Ancillary glazier/relax tools for building dependent libraries</li>
<li>Usual Windows folders <code>%windir%;%windir%\system32</code> etc</li>
<li>Various settings form the <code>otp_build</code> script</li>
</ul><p>More details are at <a href="http://github.com/erlang/otp/blob/dev/INSTALL-WIN32.md">erlang INSTALL-Win32.md on github</a></p>

<h2>Erlang</h2>

<ul>
<li>start an SDK shell via <code>setenv.cmd /Release /x86</code>
</li>
<li>launch a cygwin erl-ified shell via <code>c:\relax\bin\shell.cmd</code>
</li>
<li>choose your erlang version - R14B04 is strongly advised</li>
<li>unpack erlang source by <code>cd $RELAX &amp;&amp; tar xzf bits/otp_src_R14B04.tar.gz</code>
</li>
<li>
<p>customise Erlang by excluding unneeded Java interface and old GS GUI:</p>

<pre><code>cd $ERL_TOP
tar xvzf /relax/bits/tcltk85_win32_bin.tar.gz
echo "skipping gs" &gt; lib/gs/SKIP
echo "skipping jinterface" &gt; lib/jinterface/SKIP
</code></pre>
</li>
<li>
<p>after validating the path, I usually run these two scripts which
can take several hours on slower machines:</p>

<pre><code>erl_config.sh
erl_build.sh
</code></pre>
</li>
<li><p>the output is logged into <code>$ERL_TOP/build_*.txt</code> if required</p></li>
<li>
<p>at this point I usually duplicate the OTP source tree for later</p>

<pre><code>robocopy $ERL_TOP /relax/release/$OTP_REL -mir
</code></pre>
</li>
</ul><h2>ICU 4.6.1</h2>

<ul>
<li>Download ICU 4.6.1 windows source from <a href="http://download.icu-project.org/files/icu4c/4.6.1/icu4c-4_6_1-src.zip">icu461zip</a>
</li>
<li>
<p>either re-use the "shell.cmd" from before, or open a Windows SDK prompt
via <code>setenv /release /x86</code> again</p>

<pre><code>%relax%\bin\build_icu.cmd
</code></pre>
</li>
<li><p>confirm that the resulting ICU DLLs have the appropriate manifests</p></li>
<li>
<p>NB for MSVC9 is supported only via cygwin; use <a href="http://download.icu-project.org/files/icu4c/4.6.1/icu4c-4_6_1-src.tgz">icu461tgz</a> instead and</p>

<pre><code>cd $RELAX
DEST=`pwd`/icu
tar xzf bits/icu4c-4_6_1-src.tgz
cd $DEST/source &amp;&amp; ./runConfigureICU Cygwin/MSVC --prefix=$DEST
make &amp;&amp; make install
cp $DEST/lib/*.dll $DEST/bin/
</code></pre>
</li>
<li><p>compiling under cygwin is likely also to work for MSVC10 if a unified
build process is required.</p></li>
</ul><h2>libcurl</h2>

<p>libcurl is only required for versions of CouchDB below 1.1.1 where it is embedded
in couchjs.exe. Trunk and future releases will have this as an optional include.</p>

<ul>
<li>download <a href="http://curl.haxx.se/download/curl-7.23.1.zip">libcurl</a> source from (<a href="http://curl.haxx.se/">http://curl.haxx.se/</a>)</li>
<li>NB when using SDK7.0 I needed to <code>copy %windir%\system32\notepad.exe c:\relax\bin\bscmake.exe</code>
</li>
<li>
<p>either re-use the "shell.cmd" from before, or open a Windows SDK prompt
via <code>setenv /release /x86</code> again</p>

<pre><code>%relax%\bin\build_curl.cmd
</code></pre>
</li>
</ul><h2>Javascript</h2>

<p>The Javascript engine used by CouchDB is Mozilla Spidermonkey v1.8.5 <a href="http://ftp.mozilla.org/pub/mozilla.org/js/js185-1.0.0.tar.gz">js185</a>.</p>

<ul>
<li>to build and install SpiderMonkey we use the mozilla tools chain.</li>
<li>run <code>c:\mozilla-build\start-msvc10.bat</code> even if you are on a 64-bit platform.</li>
<li>do a sanity check to confirm the MS build compilers are present via
<code>which cl link mc lc mt</code>
</li>
<li>
<p>you may need to fudge the path if <code>cl.exe</code> can't be found using <code>PATH=$PATH:/c/relax/VC/VC/bin/:/c/relax/SDK/bin:/c/relax/VC/Common7/IDE:/c/relax/VC/VC/bin/amd64/:/c/relax/VC/VC/bin/x86_ia64/</code></p>

<pre><code>cd /c/relax
tar xzf bits/js185-1.0.0.tar.gz
cd ./js-1.8.5/js/src
autoconf-2.13
./configure --enable-static --enable-shared-js
make
</code></pre>
</li>
</ul><h2>Building CouchDB</h2>

<p>Finally we are going to build Apache CouchDB... whew! Recapping, we should have:</p>

<ul>
<li>erlang in <code>/relax/otp_src_R14B04/release/win32</code> with a copy stashed nearby</li>
<li>openssl in <code>/relax/openssl/{bin,lib}/{lib,ssl}eay32.{bin,lib}</code>
</li>
<li>libcurl in <code>/relax/curl/lib/libcurl.lib</code>
</li>
<li>js library in <code>/relax/js-1.8.5/js/src/dist/{bin,lib}/mozjs185-1.0.*</code>
</li>
<li>icu in <code>/relax/icu/bin/icu*.dll</code>
</li>
</ul><p>For CouchDB 1.1.1 or newer, two small filthy hacks are required, which
is needed until <code>configure.ac</code> avoids detection of cygwin's curl and avoids
assuming that help2man will be useful on Windows.</p>

<ul>
<li>start an SDK shell via <code>setenv.cmd /Release /x86</code>
</li>
<li>launch a cygwin erl-ified shell via <code>c:\relax\bin\shell.cmd</code>
</li>
<li>
<p>apply the work-arounds:</p>

<pre><code>mv /usr/bin/curl-config /usr/bin/curl-config.dist
mv /usr/bin/help2man /usr/bin/help2man.dist
</code></pre>
</li>
</ul><p>There are two relevant scripts for building CouchDB:</p>

<ul>
<li>
<code>couchdb_config.sh</code> for CouchDB 1.1.1 or newer, supporting js185 only</li>
<li>
<code>couchdb_build.sh</code> which compiles, and packages, CouchDB</li>
</ul><p>Let's pull the CouchDB source from git repo:</p>

<pre><code>    git clone <a href="http://git-wip-us.apache.org/repos/asf/couchdb.git">http://git-wip-us.apache.org/repos/asf/couchdb.git</a> \
      /relax/couchdb
    pushd /relax/couchdb &amp;&amp; git checkout -b 1.2.0
    git clean -fdx &amp;&amp; git reset --hard
    ./bootstrap
    /relax/bin/couchdb_config.sh &amp;&amp; /relax/bin/couchdb_build.sh
</code></pre>

<p>A few minutes later, the release binaries should be made available.</p>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Glazier maintained by <a href="https://github.com/dch">dch</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
